<!DOCTYPE html>
<html>
<head>
    <title>Live Crowd Analytics | SafeCrowd AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background:#111; color:white }
        .stat {
            background:#1e1e1e;
            padding:10px;
            border-radius:8px;
            margin-bottom:10px;
        }
        #loader {
            position:fixed;
            inset:0;
            background:black;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            z-index:9999;
        }
        .circle {
            width:120px;
            height:120px;
            border-radius:50%;
            border:10px solid #333;
            border-top:10px solid lime;
            animation:spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform:rotate(360deg) } }

        .status {
            padding:6px;
            border-radius:6px;
            font-weight:bold;
            text-align:center;
        }
        .LOW { background:green; }
        .MEDIUM { background:orange; }
        .HIGH { background:red; }
    </style>
</head>

<>

<!-- LOADER -->
<div id="loader">
    <div class="circle"></div>
    <h4 class="mt-3">Processing Video...</h4>
    <p id="percent">0%</p>
</div>

<!-- MAIN CONTENT -->
<div class="container-fluid" id="content" style="display:none">
<div class="row">

    <!-- LEFT PANEL -->
    <div class="col-md-3 p-3">
        <h4>Live Analytics</h4>

        <div class="stat">Live Count: <b id="live">0</b></div>
        <div class="stat">Unique People Count: <b id="total">0</b></div>
        <div class="stat">Average Count: <b id="average">0</b></div>
        <div class="stat">Zone Count: <b id="zone">0</b></div>
        <div class="stat">Duration: <b id="duration">0</b> sec</div>
        <div class="stat">Size: <b id="size">0</b> MB</div>

        <div class="stat">
            Crowd Status:
            <div id="status" class="status LOW">LOW</div>
        </div>

        <div class="stat text-success">
            Tracking Mode: <b>YOLOv8 + ByteTrack</b>
        </div>

        <canvas id="chart" height="180"></canvas>

        <!-- ðŸ“Š DOWNLOAD GRAPH BUTTON -->
        <button onclick="downloadChart()" class="btn btn-info w-100 mt-2">
            ðŸ“Š Download Graph
        </button>

        <a href="/download_report" class="btn btn-success w-100 mt-2">
            â¬‡ Download Report
        </a>

        <a href="/dashboard" class="btn btn-secondary w-100 mt-2">
            â¬… Back to Dashboard
        </a>
    </div>

    <!-- VIDEO PANEL -->
    <div class="col-md-9 text-center">
        <img src="/video_feed" class="img-fluid rounded mt-2">
    </div>

</div>
</div>

<!-- COMPLETION MODAL -->
<div class="modal fade" id="completeModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">âœ… Analysis Completed</h5>
      </div>
      <div class="modal-body">
        <p><b>Video processing and crowd counting are completed.</b></p>
        <p>Total People Detected: <b id="finalTotal">0</b></p>
        <p>Video Duration: <b id="finalDuration">0</b> seconds</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let labels = [];
let data = [];
let percentVal = 0;
let modalShown = false;

/* ðŸ“ˆ CHART */
const chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: {
        labels: labels,
        datasets: [{
            label: "Live Crowd Count",
            data: data,
            borderWidth: 2
        }]
    },
    options: {
        scales: {
            x: { display:false },
            y: { beginAtZero:true }
        }
    }
});

/* ðŸ“Š DOWNLOAD CHART FUNCTION */
function downloadChart() {
    const canvas = document.getElementById("chart");
    const link = document.createElement("a");
    const now = new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");
    link.download = "crowd-graph-" + now + ".png";
    link.href = canvas.toDataURL("image/png");
    link.click();
}

/* ðŸ”„ LIVE STATS UPDATE */
setInterval(() => {
    fetch("/api/stats")
        .then(r => r.json())
        .then(d => {

            /* Loader logic */
            if (d.duration === 0) {
                percentVal = Math.min(percentVal + 3, 99);
                document.getElementById("percent").innerText = percentVal + "%";
                return;
            }

            document.getElementById("loader").style.display = "none";
            document.getElementById("content").style.display = "block";

            /* Stats */
            live.innerText = d.live;
            total.innerText = d.total;
            average.innerText = d.average;
            zone.innerText = d.zone_count;
            duration.innerText = d.duration;
            size.innerText = d.size;

            status.innerText = d.status;
            status.className = "status " + d.status;

            /* Chart */
            labels.push("");
            data.push(d.live);
            if (labels.length > 30) {
                labels.shift();
                data.shift();
            }
            chart.update();

            /* Completion popup */
            if (!modalShown && d.done === true) {
                modalShown = true;
                finalTotal.innerText = d.total;
                finalDuration.innerText = d.duration;

                new bootstrap.Modal(
                    document.getElementById("completeModal")
                ).show();
            }
        });
}, 1000);
</script>

</body>
</html>
